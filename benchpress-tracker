<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bench-Press Tracker (Voice + Target Reps)</title>
<style>
  html,body{
    margin:0;height:100%;background:#0a0d12;color:#e6eaf0;
    font-family:"Segoe UI",Roboto,sans-serif;overflow:hidden;
  }
  #container{display:flex;height:100%;width:100%;}
  #stage{position:relative;flex:1;background:#000;overflow:hidden;}
  video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;}
  #hud{
    position:absolute;top:20px;left:20px;font-size:60px;font-weight:700;
    background:rgba(0,0,0,0.4);padding:12px 26px;border-radius:14px;
    backdrop-filter:blur(6px);
  }
  #buttons{position:absolute;bottom:25px;left:50%;transform:translateX(-50%);
    display:flex;gap:20px;}
  button{
    background:linear-gradient(145deg,#18232f,#10151d);color:#fff;
    border:1px solid rgba(255,255,255,0.2);border-radius:50%;
    width:120px;height:120px;font-size:20px;font-weight:600;
    cursor:pointer;transition:background .3s,transform .1s;
  }
  button:hover{background:#1a2532;}
  #controls{
    width:300px;background:rgba(20,26,34,.9);border-left:1px solid rgba(255,255,255,.05);
    padding:24px;display:flex;flex-direction:column;gap:20px;backdrop-filter:blur(8px);
  }
  h3{margin:0 0 6px;font-size:20px;color:#9bd2ff;}
  label{display:block;font-size:13px;margin-bottom:4px;color:#c5ccdb;}
  input[type=number]{
    width:100%;padding:6px 8px;background:#121a24;border:1px solid rgba(255,255,255,.15);
    color:#e6eaf0;border-radius:6px;font-size:15px;
  }
  .metric{padding:12px 14px;background:rgba(255,255,255,.05);border-radius:10px;
    border:1px solid rgba(255,255,255,.08);}
  .metric-label{font-size:13px;color:#b0b8c6;margin-bottom:4px;}
  .metric-value{font-size:24px;font-weight:700;color:#7be2ff;}
  .note{font-size:12px;color:#a0a8b5;line-height:1.4em;}
  #startOverlay{
    position:absolute;inset:0;display:flex;justify-content:center;align-items:center;
    background:rgba(0,0,0,.55);backdrop-filter:blur(4px);z-index:20;
  }
  #startBtn{
    background:radial-gradient(circle at 30% 30%,#4ade80,#15803d);
    width:200px;height:200px;border:none;border-radius:50%;color:#fff;
    font-size:28px;font-weight:700;cursor:pointer;box-shadow:0 0 25px rgba(0,255,128,.4);
  }
  #startBtn:hover{transform:scale(1.05);}
</style>
</head>
<body>
<div id="container">
  <div id="stage">
    <video id="video" playsinline muted></video>
    <canvas id="overlay"></canvas>
    <div id="hud">0</div>
    <div id="startOverlay"><button id="startBtn">Start</button></div>
  </div>

  <div id="controls">
    <h3>Workout</h3>
    <div>
      <label for="targetReps">Target Reps per Set</label>
      <input id="targetReps" type="number" min="1" max="100" value="15">
    </div>

    <h3>Thresholds</h3>
    <div>
      <label for="thHigh">Complete (straight) ≥</label>
      <input id="thHigh" type="number" min="50" max="100" value="90">
    </div>
    <div>
      <label for="thLow">Reset (bottom) ≤</label>
      <input id="thLow" type="number" min="0" max="80" value="50">
    </div>

    <div class="metric">
      <div class="metric-label">Current Straightness</div>
      <div id="currentPct" class="metric-value">0%</div>
    </div>

    <p class="note">Say “Start”, “Stop”, “Pause”, “Unpause”, or “Resume” to control tracking hands-free.</p>
  </div>
</div>

<script type="module">
import {FilesetResolver, PoseLandmarker, DrawingUtils}
  from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10";

const video=document.getElementById("video");
const canvas=document.getElementById("overlay");
const ctx=canvas.getContext("2d");
const hud=document.getElementById("hud");
const currentPct=document.getElementById("currentPct");
const startBtn=document.getElementById("startBtn");
const startOverlay=document.getElementById("startOverlay");
const thHighEl=document.getElementById("thHigh");
const thLowEl=document.getElementById("thLow");
const targetRepsEl=document.getElementById("targetReps");

let landmarker;
let reps=0,passedBottom=false,smoothed=0,paused=true;
let thHigh=90,thLow=50,minAngle=50,maxAngle=175,targetReps=15;

// ----------- AUDIO & VOICE FUNCTIONS -----------
function speak(text){
  const u=new SpeechSynthesisUtterance(text);
  u.rate=1.1;
  speechSynthesis.speak(u);
}
function playTada(){
  const tada=new Audio("https://win98icons.alexmeub.com/sounds/tada.wav");
  tada.volume=0.5;
  tada.play();
}

// ----------- CORE MATH -----------
function angle(a,b,c){
  const v1={x:a.x-b.x,y:a.y-b.y},v2={x:c.x-b.x,y:c.y-b.y};
  const dot=v1.x*v2.x+v1.y*v2.y;
  const m1=Math.hypot(v1.x,v1.y),m2=Math.hypot(v2.x,v2.y);
  return Math.acos(dot/(m1*m2))*180/Math.PI;
}
function mapAngleToPct(a){return Math.max(0,Math.min(1,(a-minAngle)/(maxAngle-minAngle)))*100;}

// ----------- REP LOGIC -----------
function repLogic(p){
  if(paused)return;
  if(p<=thLow)passedBottom=true;
  if(passedBottom&&p>=thHigh){
    reps++;hud.textContent=reps;passedBottom=false;
    speak(reps.toString());
    if(reps>=targetReps){playTada();}
  }
}

// ----------- CAMERA SETUP -----------
async function setupCamera(){
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:false});
  video.srcObject=s;await video.play();
  resizeCanvas();window.addEventListener("resize",resizeCanvas);
}
function resizeCanvas(){canvas.width=video.videoWidth;canvas.height=video.videoHeight;}

// ----------- POSE SETUP -----------
async function setupLandmarker(){
  const fs=await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10/wasm");
  landmarker=await PoseLandmarker.createFromOptions(fs,{
    baseOptions:{
      modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_full/float16/1/pose_landmarker_full.task"
    },
    runningMode:"VIDEO",numPoses:1
  });
  console.log("Pose model loaded.");
}

// ----------- DRAWING -----------
function drawPose(lms){
  const draw=new DrawingUtils(ctx);
  draw.drawLandmarks(lms,{radius:2,color:"#00ffcc"});
  draw.drawConnectors(lms,PoseLandmarker.POSE_CONNECTIONS,{color:"#00aaff",lineWidth:2});
  const s=lms[12],e=lms[14],w=lms[16];
  const W=canvas.width,H=canvas.height;
  ctx.strokeStyle="yellow";ctx.lineWidth=4;
  ctx.beginPath();ctx.moveTo(s.x*W,s.y*H);
  ctx.lineTo(e.x*W,e.y*H);ctx.lineTo(w.x*W,w.y*H);ctx.stroke();
}

// ----------- MAIN LOOP -----------
async function loop(ts){
  requestAnimationFrame(loop);
  if(!landmarker)return;
  const res=landmarker.detectForVideo(video,ts);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();ctx.scale(-1,1);
  ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);
  ctx.restore();
  if(!res.landmarks.length)return;
  const lms=res.landmarks[0];
  drawPose(lms);
  const shoulder=lms[12],elbow=lms[14],wrist=lms[16];
  const ang=angle(shoulder,elbow,wrist);
  const pct=mapAngleToPct(ang);
  smoothed=smoothed*0.8+pct*0.2;
  currentPct.textContent=Math.round(smoothed)+"%";
  repLogic(smoothed);
}

// ----------- CONTROLS -----------
function resetReps(){reps=0;hud.textContent="0";passedBottom=false;}
function togglePause(state){
  paused=state!==undefined?state:!paused;
  if(paused){
    startOverlay.style.display="flex";
  }else{
    startOverlay.style.display="none";
  }
}
startBtn.onclick=()=>togglePause(false);
thHighEl.oninput=()=>thHigh=parseFloat(thHighEl.value)||90;
thLowEl.oninput=()=>thLow=parseFloat(thLowEl.value)||50;
targetRepsEl.oninput=()=>targetReps=parseInt(targetRepsEl.value)||15;

// ----------- VOICE COMMANDS -----------
function initVoiceCommands(){
  if(!('webkitSpeechRecognition' in window||'SpeechRecognition' in window)){
    console.warn("SpeechRecognition not supported.");return;
  }
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  const recog=new SR();
  recog.continuous=true;
  recog.lang="en-US";
  recog.interimResults=false;
  recog.onresult=(e)=>{
    const cmd=e.results[e.results.length-1][0].transcript.trim().toLowerCase();
    console.log("Heard:",cmd);
    if(cmd.includes("start")||cmd.includes("resume")||cmd.includes("unpause"))togglePause(false);
    if(cmd.includes("pause")||cmd.includes("stop"))togglePause(true);
  };
  recog.onerror=(err)=>console.warn("SpeechRec error:",err);
  recog.start();
  console.log("Voice control active.");
}

// ----------- INIT -----------
(async()=>{
  await setupCamera();
  await setupLandmarker();
  initVoiceCommands();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
